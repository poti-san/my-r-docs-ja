---
parent: rlang 1.1.1 トピックス
title: コンテキスト外で注入演算子を使うと何が起こるか？
---

{% raw %}

# コンテキスト外で注入演算子を使うと何が起こるか？

注入演算子の`{{`、`!!`、`!!!`はtidyverseパッケージ集で開発されたR構文の拡張です。base Rの一部ではないため、いくつかの限界があります。その一部は想定外の場所での使用による不特定なエラーの送出です。

### `{{`のコンテキスト外使用

エンブレース演算子`{{`はtidy評価の提供するデータマスク済み引数で有効な機能です。他の場所で使うと`{`による二重囲いと解釈されます。

R言語では`{`は`(`と似ていますが、複数の式を含めます。

```r
{
  1 # 破棄されます。
  2
}
#> [1] 2

list(
  { message("foo"); 2 }
)
#> foo
#> [[1]]
#> [1] 2
```

式は好きなだけ括弧で囲めます。

```r
((1))
#> [1] 1

{{ 2 }}
#> [1] 2
```

従って、エンブレース演算子が未定義のコンテキストでも関数引数の波括弧囲いは妨げられません。Rは複数の波括弧を括弧の集まりとして扱い、静かに処理結果を返します。

```r
f <- function(arg) list({{ arg }})
f(1)
#> [[1]]
#> [1] 1
```

このような無意味な波括弧囲いは実際のコードでは避けるべきです。関数がtidy評価演算子に対応して特殊な処理が行われるように見せかけるからです。

しかし、ほとんどの波括弧囲いはデータマスクを実装します。そのような関数はRが正確に解決しないデータ変数参照を伴って呼び出せます。

```r
my_mean <- function(data, var) {
  with(data, mean({{ var }}))
}

my_mean(mtcars, cyl)
#> Error:
#> ! object 'cyl' not found
```

[`with()`](https://rdrr.io/r/base/with.html)はbase Rのデータマスク関数でtidy評価演算子に非対応ですが、エンブレース演算子は機能せず、オブジェクトの参照エラーが発生します。

### `!!`と`!!!`のコンテキスト外使用

注入演算子`!!`と`!!!`はデータマスク済み引数、動的ドット、`inject()`の内部で実装されます。異なるコンテキストで使った場合、Rは二重または三重「否定」と解釈します。通常のコードでは二重否定は入力の論理値への変換に使われます。

```r
!!10
#> [1] TRUE

!!0
#> [1] FALSE
```

同様に三重否定は単なる否定と同等です。

```r
!10
#> [1] FALSE

!!!10
#> [1] FALSE
```

つまり、注入演算子は間違った場所で使うと否定と解釈されます。最善のシナリオは型エラーで気付けた場合です。

```r
!"foo"
#> Error in `!"foo"`:
#> ! invalid argument type

!quote(foo)
#> Error in `!quote(foo)`:
#> ! invalid argument type

!quote(foo())
#> Error in `!quote(foo())`:
#> ! invalid argument type
```

最悪の場合、Rは静かに入力を論理値へ変換します。不幸にもこのバグをチェックする体系的な方法はありません。

{% endraw %}
